#!/bin/bash

# obtain the script installed path.
SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Start Milvus server
if [[ -z "${MILVUS_DEV_PATH}" ]]; then
    echo "MILVUS_DEV_PATH is not set or is empty"
    exit 1
fi
echo "MILVUS_DEV_PATH: ${MILVUS_DEV_PATH}"

if [[ -z "${MILVUS_VOLUME_DIRECTORY}" ]]; then
    echo "MILVUS_VOLUME_DIRECTORY is not set or is empty"
    exit 1
fi
echo "MILVUS_VOLUME_DIRECTORY: ${MILVUS_VOLUME_DIRECTORY}"

# Function to display usage
usage() {
    echo "Usage: $0 [OPTIONS] COMMAND"
    echo ""
    echo "OPTIONS:"
    echo "  -f    Force stop"
    echo "  -a    Enable ASAN (AddressSanitizer) debugging"
    echo "  -c    Start Milvus in cluster mode"
    echo "  -m    Start multiple Milvus clusters"
    echo "  -s    Enable streaming service"
    echo "  -k    Use Kafka as message queue (default: Pulsar)"
    echo "  -r    Use RocksMQ as message queue (default: Pulsar)"
    echo "  -u    Reuse the last volume directory instead of creating a new one"
    echo "  --primary    Start/Stop only primary Milvus instance (by-dev1, port 19530)"
    echo "  --standby    Start/Stop only standby Milvus instance (by-dev2, port 19531)"
    echo ""
    echo "COMMANDS:"
    echo "  start_milvus        Start Milvus server (standalone or cluster mode)"
    echo "  stop_milvus         Stop Milvus server"
    echo "  start_milvus_inf    Start Milvus infrastructure (Pulsar/Kafka/RMQ + etcd + minio)"
    echo "  stop_milvus_inf     Stop Milvus infrastructure"
    echo "  start_milvus_full   Start both infrastructure and Milvus server"
    echo "  stop_milvus_full    Stop both Milvus server and infrastructure"
    echo ""
    exit 1
}

# Handle all options including long options
while [[ $# -gt 0 ]]; do
    case $1 in
    -f)
        FORCED=1
        shift
        ;;
    -m)
        CLUSTERS=1
        shift
        ;;
    -c)
        CLUSTER=1
        shift
        ;;
    -s)
        STREAMING=1
        shift
        ;;
    -a)
        ASAN_ENABLED=1
        shift
        ;;
    -k)
        USE_KAFKA=1
        shift
        ;;
    -r)
        USE_RMQ=1
        shift
        ;;
    -u)
        REUSE_LAST_VOLUME=1
        shift
        ;;
    --primary)
        STOP_PRIMARY_ONLY=1
        shift
        ;;
    --standby)
        STOP_STANDBY_ONLY=1
        shift
        ;;
    -*)
        echo "Unknown option: $1"
        usage
        ;;
    *)
        break
        ;;
    esac
done

# Function to find the last milvus volume directory
find_last_milvus_volume() {
    if [[ -z "$MILVUS_VOLUME_DIRECTORY" || ! -d "$MILVUS_VOLUME_DIRECTORY" ]]; then
        echo "MILVUS_VOLUME_DIRECTORY is not set or not a directory" >&2
        return 1
    fi

    LAST_VOLUME=$(find "$MILVUS_VOLUME_DIRECTORY" -mindepth 1 -maxdepth 1 -type d ! -name '.' -printf '%T@ %p\n' | sort -k1,1nr | head -n 1 | cut -d' ' -f2-)
    if [ -n "$LAST_VOLUME" ]; then
        echo "${LAST_VOLUME}"
        return 0
    else
        echo "No volume found" >&2
        return 1
    fi
}

function generate_new_volume_directory() {
    if [[ -z "${WORKSPACE_TAG}" ]]; then
        WORKSPACE_TAG=$(date +%F-%H-%M-%S)
        echo "WORKSPACE_TAG is not set, use current time as tag: ${WORKSPACE_TAG}"
    fi
    NEW_VOLUME_DIRECTORY="${MILVUS_VOLUME_DIRECTORY}/${WORKSPACE_TAG}"
    mkdir -p "${NEW_VOLUME_DIRECTORY}" || exit 1
    echo "NEW_VOLUME_DIRECTORY: ${NEW_VOLUME_DIRECTORY}"
}

function setup_volume_directory() {
    if [[ -z "${NEW_VOLUME_DIRECTORY}" ]]; then
        if [[ -n "${REUSE_LAST_VOLUME}" ]]; then
            echo "Reusing last volume directory..."
            NEW_VOLUME_DIRECTORY=$(find_last_milvus_volume)
            if [[ $? -ne 0 || -z "${NEW_VOLUME_DIRECTORY}" ]]; then
                echo "Failed to find last volume directory, creating new one..."
                generate_new_volume_directory
            else
                echo "Reusing volume directory: ${NEW_VOLUME_DIRECTORY}"
            fi
        else
            generate_new_volume_directory
        fi
    fi
}

function start_milvus_inf() {
    setup_volume_directory
    DOCKER_COMPOSE_FILE="docker-compose-pulsar.yml"
    if [[ "${USE_KAFKA}" ]]; then
        echo "Use Kafka..."
        DOCKER_COMPOSE_FILE="docker-compose-kafka.yml"
    fi
    if [[ -n "${USE_RMQ}" ]]; then
        echo "Use RMQ..."
        DOCKER_COMPOSE_FILE="docker-compose-rmq.yml"
    fi
    pushd "$SCRIPT_PATH" || exit 1
    MILVUS_INF_VOLUME_DIRECTORY="${NEW_VOLUME_DIRECTORY}/docker-volumes/" docker compose -f "${DOCKER_COMPOSE_FILE}" up -d
    popd || exit 1
}

function stop_milvus_inf() {
    pushd "$SCRIPT_PATH" || exit 1
    DOCKER_COMPOSE_FILE="docker-compose-pulsar.yml"
    if [[ "${USE_KAFKA}" ]]; then
        echo "Use Kafka..."
        DOCKER_COMPOSE_FILE="docker-compose-kafka.yml"
    fi
    if [[ "${USE_RMQ}" ]]; then
        echo "Use RMQ..."
        DOCKER_COMPOSE_FILE="docker-compose-rmq.yml"
    fi
    docker compose -f "${DOCKER_COMPOSE_FILE}" down
    popd || exit 1
}

function start_milvus() {
    # Check for conflicting options
    if [[ -n "${STOP_PRIMARY_ONLY}" && -n "${STOP_STANDBY_ONLY}" ]]; then
        echo "Error: Cannot specify both --primary and --standby options"
        exit 1
    fi
    
    setup_volume_directory
    LOG_PATH="${NEW_VOLUME_DIRECTORY}/milvus-logs/"
    mkdir -p "${LOG_PATH}" || exit 1

    pushd "$MILVUS_DEV_PATH" || exit 1
    source "./scripts/setenv.sh"
    # export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:./lib"
    # export RPATH="$LD_LIBRARY_PATH"

    export LOG_LEVEL=debug
    # export COMMON_SECURITY_AUTHORIZATIONENABLED=true
    export MALLOC_CONF="prof:true,lg_prof_sample:1,prof_accum:true:background_thread:true"

    if [[ -n "${ASAN_ENABLED}" ]]; then
        echo "Use ASAN, disable jemalloc..."
        export LD_PRELOAD=""
    fi

    if [[ -n "${STREAMING}" ]]; then
        echo "Use streaming service..."
        export MILVUS_STREAMING_SERVICE_ENABLED=1
    fi

    export MQ_TYPE="pulsar"
    if [[ "${USE_KAFKA}" ]]; then
        echo "Use Kafka..."
        export MQ_TYPE="kafka"
    elif [[ -n "${USE_RMQ}" ]]; then
        echo "Use RMQ..."
        export MQ_TYPE="rocksmq"
        export ROCKSMQ_PATH="${NEW_VOLUME_DIRECTORY}/rocksmq/rdb_data"
    fi

    ## print the environment variables
    # export

    if [[ -n "${CLUSTERS}" ]]; then
        if [[ -n "${CLUSTER}" && -n "${STREAMING}" ]]; then
            # Multi-cluster + cluster mode + streaming: each cluster gets mixcoord, proxy, datanode, indexnode, 3 streaming nodes, cdc
            function start_cluster_streaming() {
                local prefix=$1 proxy_port=$2 internal_port=$3 rootcoord_port=$4 metrics_base=$5 log_prefix=$6
                local env_base="msgChannel_CHANNAMEPREFIX_CLUSTER=${prefix} ETCD_ROOTPATH=${prefix} MINIO_rootPath=${prefix}"
                local extra_env=""
                if [[ -n "${internal_port}" ]]; then
                    extra_env="PROXY_INTERNAL_PORT=${internal_port} ROOTCOORD_PORT=${rootcoord_port}"
                fi

                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base))     ./bin/milvus run mixture -rootcoord -querycoord -datacoord -indexcoord 1>>"${LOG_PATH}/${log_prefix}-mixcoord.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-mixcoord.stderr.log" &
                env ${env_base} ${extra_env} PROXY_PORT=${proxy_port} METRICS_PORT=$((metrics_base+1)) ./bin/milvus run proxy 1>>"${LOG_PATH}/${log_prefix}-proxy.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-proxy.stderr.log" &
                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base+2)) ./bin/milvus run datanode  1>>"${LOG_PATH}/${log_prefix}-datanode.stdout.log"  2>>"${LOG_PATH}/${log_prefix}-datanode.stderr.log" &
                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base+3)) ./bin/milvus run indexnode 1>>"${LOG_PATH}/${log_prefix}-indexnode.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-indexnode.stderr.log" &
                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base+4)) LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/${log_prefix}-sn1/data/" ./bin/milvus run streamingnode 1>>"${LOG_PATH}/${log_prefix}-sn1.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-sn1.stderr.log" &
                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base+5)) LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/${log_prefix}-sn2/data/" ./bin/milvus run streamingnode 1>>"${LOG_PATH}/${log_prefix}-sn2.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-sn2.stderr.log" &
                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base+6)) LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/${log_prefix}-sn3/data/" ./bin/milvus run streamingnode 1>>"${LOG_PATH}/${log_prefix}-sn3.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-sn3.stderr.log" &
                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base+7)) LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/${log_prefix}-qn1/data/" ./bin/milvus run querynode 1>>"${LOG_PATH}/${log_prefix}-qn1.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-qn1.stderr.log" &
                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base+8)) LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/${log_prefix}-qn2/data/" ./bin/milvus run querynode 1>>"${LOG_PATH}/${log_prefix}-qn2.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-qn2.stderr.log" &
                env ${env_base} ${extra_env} METRICS_PORT=$((metrics_base+9)) LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/${log_prefix}-qn3/data/" ./bin/milvus run querynode 1>>"${LOG_PATH}/${log_prefix}-qn3.stdout.log" 2>>"${LOG_PATH}/${log_prefix}-qn3.stderr.log" &
                env ${env_base} ${extra_env} PROXY_PORT=${proxy_port} METRICS_PORT=$((metrics_base+50)) ./bin/milvus run cdc > "${LOG_PATH}/${log_prefix}-cdc.stdout.log" 2>&1 &
            }

            if [[ -n "${STOP_PRIMARY_ONLY}" ]]; then
                echo "Starting primary cluster (by-dev1, cluster+streaming)... Log@ ${LOG_PATH}"
                start_cluster_streaming by-dev1 19530 "" "" 19100 a
            elif [[ -n "${STOP_STANDBY_ONLY}" ]]; then
                echo "Starting standby cluster (by-dev2, cluster+streaming)... Log@ ${LOG_PATH}"
                start_cluster_streaming by-dev2 19531 19528 53101 19200 b
            else
                echo "Starting milvus clusters (cluster+streaming)... Log@ ${LOG_PATH}"
                start_cluster_streaming by-dev1 19530 "" "" 19100 a
                start_cluster_streaming by-dev2 19531 19528 53101 19200 b
            fi
        else
            # Multi-cluster standalone mode (original behavior)
            if [[ -n "${STOP_PRIMARY_ONLY}" ]]; then
                echo "Starting primary milvus cluster (by-dev1)... Log@ ${LOG_PATH}"
                msgChannel_CHANNAMEPREFIX_CLUSTER=by-dev1 ETCD_ROOTPATH=by-dev1 MINIO_rootPath=by-dev1 PROXY_PORT=19530 METRICS_PORT=19091  ./bin/milvus run standalone 1>>"${LOG_PATH}/standalone.stdout.log" 2>>"${LOG_PATH}/standalone.stderr.log" &
                msgChannel_CHANNAMEPREFIX_CLUSTER=by-dev1 ETCD_ROOTPATH=by-dev1 MINIO_rootPath=by-dev1 PROXY_PORT=19530 METRICS_PORT=29091  ./bin/milvus run cdc > "${LOG_PATH}/standalone.cdc.stdout.log" 2>&1 &
            elif [[ -n "${STOP_STANDBY_ONLY}" ]]; then
                echo "Starting standby milvus cluster (by-dev2)... Log@ ${LOG_PATH}"
                msgChannel_CHANNAMEPREFIX_CLUSTER=by-dev2 ETCD_ROOTPATH=by-dev2 MINIO_rootPath=by-dev2 PROXY_PORT=19531 PROXY_INTERNAL_PORT=19528 ROOTCOORD_PORT=53101 METRICS_PORT=19092 ./bin/milvus run standalone 1>>"${LOG_PATH}/standalone2.stdout.log" 2>>"${LOG_PATH}/standalone2.stderr.log" &
                msgChannel_CHANNAMEPREFIX_CLUSTER=by-dev2 ETCD_ROOTPATH=by-dev2 MINIO_rootPath=by-dev2 PROXY_PORT=19531 PROXY_INTERNAL_PORT=19528 ROOTCOORD_PORT=53101 METRICS_PORT=29092 ./bin/milvus run cdc > "${LOG_PATH}/standalone2.cdc.stdout.log" 2>&1 &
            else
                echo "Starting milvus clusters... Log@ ${LOG_PATH}"
                msgChannel_CHANNAMEPREFIX_CLUSTER=by-dev1 ETCD_ROOTPATH=by-dev1 MINIO_rootPath=by-dev1 PROXY_PORT=19530 METRICS_PORT=19091  ./bin/milvus run standalone 1>>"${LOG_PATH}/standalone.stdout.log" 2>>"${LOG_PATH}/standalone.stderr.log" &
                msgChannel_CHANNAMEPREFIX_CLUSTER=by-dev1 ETCD_ROOTPATH=by-dev1 MINIO_rootPath=by-dev1 PROXY_PORT=19530 METRICS_PORT=29091  ./bin/milvus run cdc > "${LOG_PATH}/standalone.cdc.stdout.log" 2>&1 &
                msgChannel_CHANNAMEPREFIX_CLUSTER=by-dev2 ETCD_ROOTPATH=by-dev2 MINIO_rootPath=by-dev2 PROXY_PORT=19531 PROXY_INTERNAL_PORT=19528 ROOTCOORD_PORT=53101 METRICS_PORT=19092 ./bin/milvus run standalone 1>>"${LOG_PATH}/standalone2.stdout.log" 2>>"${LOG_PATH}/standalone2.stderr.log" &
                msgChannel_CHANNAMEPREFIX_CLUSTER=by-dev2 ETCD_ROOTPATH=by-dev2 MINIO_rootPath=by-dev2 PROXY_PORT=19531 PROXY_INTERNAL_PORT=19528 ROOTCOORD_PORT=53101 METRICS_PORT=29092 ./bin/milvus run cdc > "${LOG_PATH}/standalone2.cdc.stdout.log" 2>&1 &
            fi
        fi
    elif [[ -z "${CLUSTER}" ]]; then
        echo "Starting milvus standalone... Log@ ${LOG_PATH}"
        METRICS_PORT=19091 ./bin/milvus run standalone 1>"${LOG_PATH}/standalone.stdout.log" 2>"${LOG_PATH}/standalone.stderr.log" &
    else
        echo "Starting milvus cluster... Log@ ${LOG_PATH}"
        if [[ -z "${STREAMING}" ]]; then
            METRICS_PORT=19092 ./bin/milvus run mixture -rootcoord -querycoord -datacoord -indexcoord 1>"${LOG_PATH}/mixcoord.stdout.log" 2>"${LOG_PATH}/mixcoord.stderr.log" &
            METRICS_PORT=19093 ./bin/milvus run proxy 1>"${LOG_PATH}/proxy.stdout.log" 2>"${LOG_PATH}/proxy.stderr.log" &
            METRICS_PORT=19094 LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/querynode/data/" ./bin/milvus run querynode 1>"${LOG_PATH}/querynode.stdout.log" 2>"${LOG_PATH}/querynode.stderr.log" &
            METRICS_PORT=19095 ./bin/milvus run datanode 1>"${LOG_PATH}/datanode.stdout.log" 2>"${LOG_PATH}/datanode.stderr.log" &
            METRICS_PORT=19096 ./bin/milvus run indexnode 1>"${LOG_PATH}/indexnode.stdout.log" 2>"${LOG_PATH}/indexnode.stderr.log" &
            # METRICS_PORT=19097 ./bin/milvus run datanode 1>"${LOG_PATH}/datanode2.stdout.log" 2>"${LOG_PATH}/datanode2.stderr.log" &
        else
            METRICS_PORT=19092 ./bin/milvus run mixture -rootcoord -querycoord -datacoord -indexcoord 1>"${LOG_PATH}/mixcoord.stdout.log" 2>"${LOG_PATH}/mixcoord.stderr.log" &
            METRICS_PORT=19093 ./bin/milvus run proxy 1>"${LOG_PATH}/proxy.stdout.log" 2>"${LOG_PATH}/proxy.stderr.log" &
            METRICS_PORT=19094 LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/querynode/data/" ./bin/milvus run querynode 1>"${LOG_PATH}/querynode.stdout.log" 2>"${LOG_PATH}/querynode.stderr.log" &
            METRICS_PORT=19095 ./bin/milvus run datanode 1>"${LOG_PATH}/datanode.stdout.log" 2>"${LOG_PATH}/datanode.stderr.log" &
            METRICS_PORT=19096 ./bin/milvus run indexnode 1>"${LOG_PATH}/indexnode.stdout.log" 2>"${LOG_PATH}/indexnode.stderr.log" &
            METRICS_PORT=19097 LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/streamingnode/data/" ./bin/milvus run streamingnode 1>"${LOG_PATH}/streamingnode.stdout.log" 2>"${LOG_PATH}/streamingnode.stderr.log" &
            METRICS_PORT=19098 LOCALSTORAGE_PATH="${NEW_VOLUME_DIRECTORY}/streamingnode2/data/" ./bin/milvus run streamingnode 1>"${LOG_PATH}/streamingnode2.stdout.log" 2>"${LOG_PATH}/streamingnode2.stderr.log" &
        fi
    fi
    popd || exit 1
}

function stop_milvus() {
    # Check for conflicting options
    if [[ -n "${STOP_PRIMARY_ONLY}" && -n "${STOP_STANDBY_ONLY}" ]]; then
        echo "Error: Cannot specify both --primary and --standby options"
        exit 1
    fi

    # Find all milvus PIDs belonging to a cluster by ETCD_ROOTPATH env var
    find_cluster_pids() {
        local etcd_root=$1
        local pids=""
        for pid in $(pgrep -x milvus 2>/dev/null); do
            if tr '\0' '\n' < /proc/$pid/environ 2>/dev/null | grep -q "ETCD_ROOTPATH=$etcd_root"; then
                pids="$pids $pid"
            fi
        done
        echo $pids
    }

    kill_pids() {
        local pids="$1"
        local label="$2"
        if [[ -n "$pids" ]]; then
            if [[ -z "${FORCED}" ]]; then
                echo "Graceful stopping ${label}..."
                kill $pids 2>/dev/null
            else
                echo "Force stopping ${label}..."
                kill -9 $pids 2>/dev/null
            fi
            echo "${label} stopped (PIDs:$pids)"
        else
            echo "No ${label} processes found"
        fi
    }

    if [[ -n "${STOP_PRIMARY_ONLY}" ]]; then
        echo "Stopping primary Milvus instance (by-dev1)..."
        pids=$(find_cluster_pids "by-dev1")
        kill_pids "$pids" "primary cluster (by-dev1)"
    elif [[ -n "${STOP_STANDBY_ONLY}" ]]; then
        echo "Stopping standby Milvus instance (by-dev2)..."
        pids=$(find_cluster_pids "by-dev2")
        kill_pids "$pids" "standby cluster (by-dev2)"
    else
        # Default behavior: stop all Milvus processes
        if [[ -z "${FORCED}" ]]; then
            echo "Stopping all Milvus servers..."
            killall milvus 2>/dev/null
        else
            echo "Force stopping all Milvus servers..."
            killall -9 milvus 2>/dev/null
        fi
    fi
}

# Handle options
case "$1" in
start_milvus_inf)
    start_milvus_inf
    ;;
stop_milvus_inf)
    stop_milvus_inf
    ;;
start_milvus)
    start_milvus
    ;;
stop_milvus)
    stop_milvus
    ;;
start_milvus_full)
    start_milvus_inf
    start_milvus
    ;;
stop_milvus_full)
    stop_milvus
    stop_milvus_inf
    ;;
*)
    usage
    ;;
esac

# Check if no option was provided
if [ $# -eq 0 ]; then
    usage
fi
